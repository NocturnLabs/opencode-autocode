<template>
<content><![CDATA[
# JavaScript/TypeScript Module

Read this module when working on web projects with JavaScript or TypeScript.

## Toolchain: Use Bun

**Always use `bun` instead of npm, pnpm, or yarn.**

- Install deps: `bun install`
- Run scripts: `bun run dev`
- Tests: `bun test`
- Init: `bun init`

---

## Port Conflict Prevention

Before starting any servers or running tests, verify required ports are free:

```bash
# Check if default ports are in use (ss is more reliable than lsof)
ss -tlnH "sport = :8000" | grep -q . && echo "Port 8000 in use" || echo "Port 8000 free"
ss -tlnH "sport = :3000" | grep -q . && echo "Port 3000 in use" || echo "Port 3000 free"
```

**If ports are occupied:**

- **NEVER kill a process unless you are 100% sure it belongs to this project and was started by you.**
- Search for a free port instead (8001, 8002, etc.)
- Update `playwright.config.ts` or other configs:
  ```bash
  sed -i 's/localhost:[0-9]*/localhost:NEW_PORT/g' playwright.config.ts
  ```

---

## ES6 Module Import Verification

Before marking a feature as passing, verify imports are correct:

1. **Check for import errors** in browser console (`ReferenceError`, `SyntaxError`)

2. **For each file you created or modified:**

   - Verify all `import` statements point to correct relative paths
   - Verify all imported names match `export` names in source files
   - Check that ES6 module files use `.js` extensions in imports (for browser)

3. **Quick import validation:**

   ```bash
   # List all exports in the project
   grep -rn "export class\|export function\|export const" src/**/*.js src/**/*.ts 2>/dev/null | head -20

   # List all imports in the project
   grep -rn "^import " src/**/*.js src/**/*.ts 2>/dev/null | head -20
   ```

4. **Common issues to check:**
   - Missing imports (class used but not imported)
   - Wrong paths (`./service.js` vs `./services/service.js`)
   - Named vs default export mismatch (`import { X }` vs `import X`)

---

## init.sh Template for Web Projects

```bash
#!/bin/bash
# init.sh with port conflict prevention and PID tracking

DEFAULT_PORT=8000
PORT=$DEFAULT_PORT

# Find an available port (Python bind check is the most reliable across environments)
find_free_port() {
    local port=$1
    while ! python3 -c "import socket; s = socket.socket(socket.AF_INET, socket.SOCK_STREAM); s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1); s.bind(('0.0.0.0', $port))" &>/dev/null; do
        port=$((port + 1))
    done
    echo $port
}

PORT=$(find_free_port $DEFAULT_PORT)
echo "Starting server on port $PORT"
export PORT

# Start the server and capture PID
bun run dev --port $PORT &
SERVER_PID=$!

echo "Server running at http://localhost:$PORT (PID: $SERVER_PID)"

# IMPORTANT: Save PID to knowledge DB for safe cleanup
opencode-forger db knowledge set "server_port_${PORT}_pid" "$SERVER_PID" --category servers --description "Dev server on port $PORT"
```

---

## Server Cleanup: Only Kill What You Started

> [!CAUTION]
> **NEVER run `pkill python` or `killall node`.** This can kill processes belonging to other projects.

**Safe cleanup using tracked PIDs:**

```bash
# Get the tracked PID for port 8000
TRACKED_PID=$(opencode-forger db knowledge get server_port_8000_pid 2>/dev/null | head -n 1 | cut -d= -f2)

if [ -n "$TRACKED_PID" ] && kill -0 "$TRACKED_PID" 2>/dev/null; then
    echo "Killing server on port 8000 (PID: $TRACKED_PID)"
    kill "$TRACKED_PID"
    # Remove from knowledge DB
    opencode-forger db knowledge delete server_port_8000_pid
else
    echo "No tracked server found for port 8000 (or already stopped)"
fi
```

**Rule of thumb:**
- If port is in use and NOT in your knowledge DB → find another port.
- If port is in use and IS in your knowledge DB → kill using tracked PID.
]]></content>
</template>
